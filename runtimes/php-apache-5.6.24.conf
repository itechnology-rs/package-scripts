name:      "php-apache-5.6.24"
namespace: "/apcera/pkg/runtimes"
version:   "5.6.24"

# See ../Verification.md for release verification

sources [
 { url: "https://apcera-sources.s3.amazonaws.com/php/php-5.6.24.tar.gz",
    sha256: "5f8b2e4e00360fee6eb1b89447266ae45993265955bd1ea9866270d75cdb6ec1" },
 { url: "https://apcera-sources.s3.amazonaws.com/php/freetype-2.5.5.tar.gz",
    sha256: "5d03dd76c2171a7601e9ce10551d52d4471cf92cd205948e60289251daddffa8" },
  { url: "https://apcera-sources.s3.amazonaws.com/php/jpegsrc.v9b.tar.gz",
    sha256: "240fd398da741669bf3c90366f58452ea59041cacc741a489b99f2f6a0bad052" },
  { url: "https://apcera-sources.s3.amazonaws.com/php/libpng-1.6.23.tar.gz",
    sha256: "74a9db9ddd66caa64be82bfcb3cbec4fc4394ceb1053cb7e94b2a0aa9b78eb88" },
]

build_depends [ { package: "build-essential" } ]
depends       [ { os: "ubuntu" },
                { package: "apache-2.2.31" } ]
provides      [ { runtime: "php" },
                { runtime: "php-5" },
                { runtime: "php-5.6" },
                { runtime: "php-5.6.24" },
                { runtime: "php-apache" },
                { runtime: "php-apache-5" },
                { runtime: "php-apache-5.6" },
                { runtime: "php-apache-5.6.24" } ]

environment { "PATH":          "/opt/apcera/php-5.6.24/bin:$PATH",
              "PHP_BASE_PATH": "/opt/apcera/php-5.6.24",
              "PHP_EXT_PATH":  "/opt/apcera/php-5.6.24/ext" }

# NB: anything here that's not Apache-specific should be sync'd into the
#     corresponding php-fpm-nginx runtime configuration, to keep facilities
#     matching.
build (
      export BUILDPATH=`pwd`
      export INSTALLPATH=/opt/apcera/php-5.6.24
      export PATH="${INSTALLPATH:?}/bin:$PATH"
      APXS=`which apxs`

      tar xvf jpegsrc.v9b.tar.gz
      (
        cd jpeg-9b
        ./configure --prefix=${INSTALLPATH}
        make
        sudo make install
      )

      tar xvf libpng-1.6.23.tar.gz
      (
        cd libpng-1.6.23
        ./configure --prefix=${INSTALLPATH}
        make
        sudo make install
      )

      tar xvf freetype-2.5.5.tar.gz
      (
        cd freetype-2.5.5
        ./configure --prefix=${INSTALLPATH}
        make
        sudo make install
      )

      # fix up for PHP configure
      (
        cd ${INSTALLPATH:?}/include/freetype2
        sudo ln -s . freetype
      )

      tar xvf php-5.6.24.tar.gz
      (
        cd php-5.6.24
        ./configure \
          --prefix=${INSTALLPATH:?} \
          --with-apxs2=${APXS:?} \
          --with-mysql \
          --with-pdo-mysql \
          --with-pgsql \
          --with-pdo-pgsql \
          --with-bz2 \
          --with-curl \
          --with-gd \
          --with-gettext \
          --with-iconv \
          --with-mhash \
          --with-openssl \
          --with-pcre-regex \
          --with-pear \
          --with-xmlrpc \
          --with-zend-vm \
          --with-zlib \
          --enable-bcmath \
          --enable-calendar \
          --enable-dba \
          --enable-exif \
          --enable-gd-native-ttf \
          --enable-mbstring \
          --enable-shmop \
          --enable-soap \
          --enable-sockets \
          --enable-sysvmsg \
          --enable-zip \
          --enable-opcache \
          --with-jpeg-dir=${INSTALLPATH:?} \
          --with-png-dir=${INSTALLPATH:?} \
          --with-freetype-dir=${INSTALLPATH:?} \
          --with-config-file-path=/app/conf
        make
        sudo make install

        sudo mkdir ${INSTALLPATH:?}/ext
        sudo mv ${APACHE_ROOT:?}/modules/libphp5.so ${INSTALLPATH:?}/ext

        sudo mkdir ${INSTALLPATH:?}/conf
        sudo cp php.ini-production ${INSTALLPATH:?}/conf/php.ini

        cd ${INSTALLPATH:?}/conf

        # Add extensions dir.
        # This extensions directory changes based on the php version. Please
        # double check this path when updating the package.
        sudo bash -c "echo 'extension_dir=/opt/apcera/php-5.6.24/lib/php/extensions/no-debug-non-zts-20131226' >> php.ini"

        # Update max file upload size to 32MB
        sudo sed -i 's/upload_max_filesize = .*/upload_max_filesize = 32M/' php.ini

        # Enable opcache.
        sudo sed -i 's/;opcache.enable=0/opcache.enable=1/' php.ini
        sudo sed -i 's/;opcache.enable_cli=0/opcache.enable_cli=1/' php.ini

        # Make sure the extensions path here matches the one above.
        sudo bash -c "echo 'zend_extension=/opt/apcera/php-5.6.24/lib/php/extensions/no-debug-non-zts-20131226/opcache.so' >> php.ini"

        sudo ${INSTALLPATH:?}/bin/pecl install memcache
        sudo bash -c "echo 'extension=memcache.so' >> php.ini"

        sudo ${INSTALLPATH:?}/bin/pecl install uploadprogress
        sudo bash -c "echo 'extension=uploadprogress.so' >> php.ini"
      )
)
